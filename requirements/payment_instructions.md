# Payment & Credit System Overview
This guide outlines the implementation of payments and credit system for the emoji generator app

# Tech Stack
- Next.js
- Razorpay for payments
- Supabase for database
- Clerk for authentication

# Database Schema Additions
TABLE transactions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id TEXT NOT NULL REFERENCES profiles(user_id),
  package_name TEXT NOT NULL,
  amount NUMERIC NOT NULL,
  credits_added INTEGER NOT NULL,
  payment_id TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('success', 'failed', 'pending')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);

TABLE credit_usage (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id TEXT NOT NULL REFERENCES profiles(user_id),
  emoji_id BIGINT NOT NULL REFERENCES emojis(id),
  credits_used INTEGER NOT NULL DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);

# Package Tiers
## Basic Package
- Price: ₹40
- Credits: 5
- Cost per emoji: ₹8

## Premium Package
- Price: ₹100
- Credits: 15
- Cost per emoji: ₹6.67

## Pro Package
- Price: ₹300
- Credits: 50
- Cost per emoji: ₹6

# Requirements

## 1. Credit System Implementation
- Check user's credit balance before emoji generation
- Deduct 1 credit per emoji generation
- Redirect to pricing page if credits are insufficient
- Update profiles table to reflect credit changes

## 2. Payment Integration
- Implement Razorpay payment gateway
- Create order ID before payment initiation
- Handle payment success/failure callbacks
- Update user credits only after successful payment
- Store transaction details in transactions table

## 3. Profile Page Features
- Display current credit balance
- Show transaction history
- Display credit usage history
- Allow package purchase

## 4. Payment Flow
1. User selects package
2. Create Razorpay order
3. User completes payment
4. Verify payment signature
5. Update user credits
6. Store transaction details
7. Redirect to profile page on success

# Documentation Reference
https://razorpay.com/docs

## Razorpay Integration Example
Keep in mind, we need to do this in typescript.
// Initialize Razorpay
const razorpay = new Razorpay({
key_id: process.env.RAZORPAY_KEY_ID,
key_secret: process.env.RAZORPAY_KEY_SECRET
});
// Create order
const order = await razorpay.orders.create({
amount: amount 100, // amount in paisa
currency: 'INR',
receipt: 'receipt_id',
});
// Payment verification
const verifyPayment = (razorpay_order_id, razorpay_payment_id, razorpay_signature) => {
const generated_signature = crypto
.createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
.update(${razorpay_order_id}|${razorpay_payment_id})
.digest('hex');
return generated_signature === razorpay_signature;
};


# API Routes Required
- POST /api/create-order
- POST /api/verify-payment
- GET /api/user/credits
- GET /api/user/transactions
- GET /api/user/credit-usage

# Security Considerations
- Verify Razorpay webhook signatures
- Implement idempotency for payment processing
- Secure storage of Razorpay credentials
- Implement proper error handling for payment failures